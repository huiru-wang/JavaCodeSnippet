[创建型 - 单例模式(Singleton pattern)](https://pdai.tech/md/dev-spec/pattern/2_singleton.html)

# 普遍的实现方式

- 懒汉：懒加载，用的时候才首次创建；需要额外保证线程安全；

- 饿汉：程序启动就加载完成，一般为线程安全的；

- 根据语言特性、API、虚拟机等机制实现；

# 懒汉式

1、非线程安全

```java
public class Singleton {
    private static final Singleton instance;
    public static Singleton getInstance(){
        if (instance == null){
            instance = new Singleton();
        }
        return instance;
    }
}
```

2、加锁保证线程安全，整个方法加锁

```java
public class Singleton{
    private static final Singleton instance;
    // 加锁
    public static synchronized Singleton getInstance(){
        if (instance == null){
            instance = new Singleton();
        }
        return instance;
    }
}
```

3、双重检测，降低锁粒度

如果有线程阻塞在synchronized前，且无二次判断，则有可能再次创建对象；

```java
public class Singleton{
    private static final Singleton instance;

    public static Singleton getInstance(){
        if (instance == null){
            // 加锁
            synchronized (Singleton.class) {
                if (instance == null){
                    instance = new Singleton();
                }
            }
        }
        return instance;
    }
}
```

# 饿汉式

天然线程安全

```java
public class Singleton {
    private static final Singleton instance = new Singleton();
    public static Singleton getInstance(){
        return instance;
    }
}
```

# 语言支持的实现

go：sync.Once

java：

- 枚举

- 静态内部类(借助类加载机制只初始化一次，且做到<mark>懒加载+无锁</mark>)

```java
public class Singleton {

    private Singleton() {
    }

    private static class SingletonHolder {
        private static final Singleton INSTANCE = new Singleton();
    }

    public static Singleton getUniqueInstance() {
        return SingletonHolder.INSTANCE;
    }
}
```
